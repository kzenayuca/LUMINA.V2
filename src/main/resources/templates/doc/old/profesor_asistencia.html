<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia del Profesor</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f3f6fa;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #004e98;
            color: white;
            padding: 20px;
            text-align: center;
        }
        main {
            padding: 30px;
            text-align: center;
        }
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #004e98;
            color: white;
        }
        select {
            padding: 5px;
        }
        .info {
            color: #555;
            margin-top: 15px;
        }
        .boton {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
        }
        .boton:hover {
            background-color: #0056b3;
        }
        .subir {
            background-color: #28a745;
        }
        .subir:hover {
            background-color: #1e7e34;
        }
        .reloj {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>

<header>
    <h1>üßë‚Äçüè´ Registro de Asistencia del Profesor</h1>
    <p>Profesor: <strong>Juan P√©rez</strong> | IP: <span id="ip">Cargando...</span></p>
    <p>Ubicaci√≥n: <span id="ubicacion">Obteniendo geolocalizaci√≥n...</span></p>
</header>

<main>
    <h2>Control de Asistencia</h2>

    <button class="boton subir" onclick="subirSilabo()">üìò Subir S√≠labus del Curso</button>
    <input type="file" id="archivoSilabo" accept=".pdf,.docx" style="display:none;">

    <p id="estadoSilabo" style="margin-top:10px; color:#666;">S√≠labo no subido ‚ùå</p>

    <h2>Lista de Estudiantes</h2>

  <table id="tablaAsistencia">
    <thead>
      <tr>
        <th>Estudiante</th>
        <th>Asistencia</th>
      </tr>
    </thead>
    <tbody id="contenidoTabla">
      <!-- Se llenar√° din√°micamente -->
    </tbody>
  </table>


<script>
    // Variables globales
    let tiempo = 15 * 60;
    let silaboSubido = false;

    // Obtener IP simulada
    document.getElementById('ip').textContent = "192.168.0.25 (Presencial)";

    // Obtener geolocalizaci√≥n real del profesor
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude.toFixed(4);
            const lon = pos.coords.longitude.toFixed(4);
            document.getElementById("ubicacion").textContent = `Lat: ${lat}, Lon: ${lon} ‚úÖ`;
        }, () => {
            document.getElementById("ubicacion").textContent = "No se pudo obtener ubicaci√≥n ‚ùå";
        });
    } else {
        document.getElementById("ubicacion").textContent = "Geolocalizaci√≥n no soportada ‚ùå";
    }

    // Contador de 15 minutos
    const contador = document.getElementById('contador');
    const timer = setInterval(() => {
        let min = Math.floor(tiempo / 60);
        let seg = tiempo % 60;
        contador.textContent = `${min}:${seg < 10 ? '0' + seg : seg}`;
        tiempo--;
        if (tiempo < 0) {
            clearInterval(timer);
            alert("‚è∞ Tiempo para registrar asistencia finalizado.");
            document.getElementById('btnGuardar').disabled = true;
        }
    }, 1000);
    
async function cargarEstudiantes() {
    try {
      // si tu proyecto tiene contexto, agrega el prefijo: '/lumina/api/estudiantes'
      const respuesta = await fetch('/Lumina1/api/estudiantes', {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      });

      if (!respuesta.ok) {
        throw new Error('Respuesta no OK: ' + respuesta.status);
      }

      const lista = await respuesta.json(); // array de objetos {cui, idUsuario, apellidosNombres, correoInstitucional, numeroMatricula}
      const tbody = document.getElementById("contenidoTabla");
      tbody.innerHTML = "";

      if (!Array.isArray(lista) || lista.length === 0) {
        const fila = document.createElement('tr');
        fila.innerHTML = `<td colspan="2">No hay estudiantes registrados.</td>`;
        tbody.appendChild(fila);
        return;
      }

      lista.forEach(est => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>
            <div style="text-align:left;">
              <div style="font-weight:700;">${escapeHtml(est.apellidosNombres)}</div>
              <div style="font-size:12px;color:#666;">${escapeHtml(est.correoInstitucional)} ¬∑ Mat: ${est.numeroMatricula}</div>
            </div>
          </td>
          <td>
            <select>
              <option>Presente</option>
              <option>Falta</option>
            </select>
          </td>
        `;
        tbody.appendChild(fila);
      });

    } catch (err) {
      console.error("Error cargando estudiantes:", err);
      const tbody = document.getElementById("contenidoTabla");
      tbody.innerHTML = `<tr><td colspan="2">Error al cargar estudiantes: ${escapeHtml(err.message || err)}</td></tr>`;
    }
  }

  // peque√±a funci√≥n para escapar HTML y evitar XSS
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, function (m) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

  // Llamada inicial
  cargarEstudiantes();

  function registrarAsistencia() {
    const filas = document.querySelectorAll("#contenidoTabla tr");
    let asistencia = "Alumno,Asistencia\n";

    filas.forEach(fila => {
      const nombre = fila.cells[0].innerText;
      const estado = fila.querySelector("select").value;
      asistencia += `${nombre},${estado}\n`;
    });

    const blob = new Blob([asistencia], { type: "text/csv" });
    const enlace = document.createElement("a");
    enlace.href = URL.createObjectURL(blob);
    enlace.download = "asistencia.csv";
    enlace.click();

    alert("‚úÖ Asistencia registrada correctamente");
  }

  // Cargar estudiantes al iniciar
  cargarEstudiantes();

 // Subida del s√≠labo
    function subirSilabo() {
        document.getElementById("archivoSilabo").click();
    }

    document.getElementById("archivoSilabo").addEventListener("change", function() {
        if (this.files.length > 0) {
            silaboSubido = true;
            document.getElementById("estadoSilabo").textContent = "S√≠labo subido correctamente ‚úÖ";
            document.getElementById("tablaAsistencia").style.display = "table";
            document.getElementById("btnGuardar").style.display = "inline-block";
            alert("üìò S√≠labo cargado. Ahora puede registrar asistencia (HU 5.1.1).");
        }
    });

    // Registro de asistencia
    function registrarAsistencia() {
        if (!silaboSubido) {
            alert("‚ö†Ô∏è No puede registrar asistencia sin subir el s√≠labo del curso.");
            return;
        }

        alert("‚úÖ Asistencia registrada correctamente.");
    }
</script>

</body>
</html>
