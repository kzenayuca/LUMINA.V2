<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Subir Sílabos - LUMINA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--primary:#3498db;--secondary:#2c3e50;--accent:#9b59b6;--light:#ecf0f1;--dark:#2c3e50;--success:#2ecc71;--warning:#f39c12;--danger:#e74c3c;--info:#1abc9c;--sidebar-width:280px}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
        body{display:flex;min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#333}
        .sidebar{width:var(--sidebar-width);background:rgba(44,62,80,.95);color:#fff;height:100vh;position:fixed;overflow-y:auto;box-shadow:3px 0 15px rgba(0,0,0,.2);z-index:1000;backdrop-filter:blur(10px)}
        .logo{padding:25px 20px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;gap:12px;background:rgba(52,73,94,.8)}
        .logo h1{font-size:1.4rem;font-weight:600;background:linear-gradient(45deg,#3498db,#9b59b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .logo i{color:#3498db;font-size:1.8rem}
        .user-info{padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,.1);background:rgba(52,73,94,.5)}
        .user-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(45deg,#3498db,#9b59b6);display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:white;box-shadow:0 4px 10px rgba(0,0,0,.2)}
        .user-details h3{font-size:1.1rem;margin-bottom:5px}
        .user-details p{font-size:.85rem;opacity:.8}
        .menu{padding:20px 0}
        .menu-section{margin-bottom:15px}
        .menu-title{padding:12px 20px;font-size:.85rem;text-transform:uppercase;opacity:.7;letter-spacing:1px;font-weight:600}
        .menu-item{padding:14px 20px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .3s;border-left:4px solid transparent;text-decoration:none;color:white}
        .menu-item:hover{background:rgba(255,255,255,.1);border-left:4px solid var(--primary);padding-left:25px}
        .menu-item.active{background:rgba(52,152,219,.2);border-left:4px solid var(--primary)}
        .menu-item i{width:20px;text-align:center;font-size:1.1rem}
        .main-content{flex:1;margin-left:var(--sidebar-width);padding:25px;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);min-height:100vh}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid rgba(0,0,0,.1)}
        .header h1{color:var(--secondary);font-size:2rem;font-weight:700}
        .breadcrumb{display:flex;align-items:center;gap:10px;color:#7f8c8d;font-size:.9rem}
        .course-upload-block{background:white;border-radius:15px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);margin-bottom:30px;border:1px solid #f0f0f0}
        .upload-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .upload-title{display:flex;align-items:center;gap:10px;font-size:1.5rem;color:var(--secondary)}
        .status-badge{padding:8px 15px;border-radius:20px;font-weight:600;display:flex;align-items:center;gap:8px;font-size:.9rem}
        .status-pending{background:var(--warning);color:white}
        .status-uploaded{background:var(--success);color:white}
        .requirements{background:#fff9e6;border-left:4px solid var(--warning);padding:15px;border-radius:8px;margin-bottom:25px}
        .requirements h4{color:var(--warning);margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .requirements ul{padding-left:20px;color:#7f8c8d;font-size:.95rem}
        .syllabus-upload-section{display:flex;align-items:center;gap:15px;margin-bottom:25px;padding-bottom:15px;border-bottom:1px dashed #ecf0f1}
        .btn-upload-syllabus{background:var(--primary);color:white;border:none;padding:12px 25px;border-radius:8px;font-weight:600;cursor:pointer;transition:background .3s;display:inline-flex;align-items:center;gap:8px;min-width:200px;justify-content:center}
        .btn-upload-syllabus:hover{background:#2980b9}
        .file-upload-display{font-style:italic;color:#7f8c8d;font-size:.9rem}
        .content-form h3{color:var(--secondary);margin-bottom:20px;border-bottom:2px solid var(--accent);padding-bottom:5px;font-size:1.3rem}
        .unit-list{display:flex;flex-direction:column;gap:20px}
        .unit-item{background:#f8f9fa;border:1px solid #dcdde1;padding:15px;border-radius:10px;overflow:hidden}
        .unit-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;cursor:pointer}
        .unit-header h4{margin:0;color:var(--primary);font-size:1.1rem;display:flex;align-items:center;gap:10px;flex-grow:1}
        .unit-header .unit-actions button{background:none;border:none;color:var(--danger);cursor:pointer;font-size:.9rem;margin-left:10px;transition:color .2s}
        .unit-header .unit-actions button:hover{color:#c0392b}
        .toggle-themes{transition:transform .3s ease;color:var(--secondary)}
        .unit-item.collapsed .toggle-themes{transform:rotate(-90deg)}
        .unit-content{transition:max-height .3s ease-out,opacity .3s ease-out;max-height:1000px;opacity:1}
        .unit-item.collapsed .unit-content{max-height:0;opacity:0}
        .theme-list{margin-top:10px;padding-left:20px;border-left:2px solid #bdc3c7}
        .theme-item{display:flex;align-items:center;margin-bottom:8px;gap:10px;background:white;padding:8px;border-radius:6px;border:1px solid #eee}
        .theme-item input[type="text"]{flex-grow:1;padding:8px;border:1px solid #bdc3c7;border-radius:4px}
        .btn-add-theme{background:var(--info);color:white;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;transition:background .2s;font-weight:500;display:flex;align-items:center;gap:5px;font-size:.9rem;margin-top:10px}
        .btn-add-theme:hover{background:#16a085}
        .btn-add-unit{background:var(--accent);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;transition:background .2s;margin-top:20px;display:block;width:100%;font-weight:600}
        .btn-add-unit:hover{background:#8e44ad}
        .btn-save-content{background:var(--primary);color:white;border:none;padding:15px 30px;border-radius:8px;cursor:pointer;transition:background .3s;margin-top:30px;font-size:1.1rem;font-weight:700}
        .btn-save-content:hover{background:#2980b9}
        .input-hidden-file{display:none}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:white;border-radius:15px;padding:30px;max-width:500px;width:90%;text-align:center;box-shadow:0 15px 40px rgba(0,0,0,.2)}
        .modal-icon{font-size:4rem;color:var(--success);margin-bottom:20px}
        .modal h2{color:var(--secondary);margin-bottom:15px}
        .modal p{color:#7f8c8d;margin-bottom:25px;line-height:1.5}
        .modal-actions{display:flex;justify-content:center;gap:15px}
        @media (max-width:992px){.sidebar{width:70px;overflow:visible}.logo h1,.user-details,.menu-title,.menu-item span{display:none}.main-content{margin-left:70px}.logo{justify-content:center}.user-info{justify-content:center}.menu-item{justify-content:center;padding:15px 0}}
        @media (max-width:768px){.syllabus-upload-section{flex-direction:column;align-items:stretch}.btn-upload-syllabus{width:100%;min-width:auto}}
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"><i class="fas fa-university"></i><h1>LUMINA PROFESOR</h1></div>
        <div class="user-info">
            <div class="user-avatar"><i class="fas fa-user-tie"></i></div>
            <div class="user-details">
                <h3 id="profesor-name">Profesor</h3>
                <p>IP: 192.168.1.45 (Presencial)</p>
            </div>
        </div>

        <div class="menu">
            <div class="menu-section">
                <a href="nuevo_profesor.html" class="menu-item"><i class="fas fa-tachometer-alt"></i><span>DASHBOARD</span></a>
                <div class="menu-title">Panel Principal</div>
            </div>
            <div class="menu-section"><a href="nuevo_profesor_asistenciabloqueada.html" class="menu-item"><i class="fas fa-clipboard-check"></i><span>REGISTRAR ASISTENCIA</span></a></div>
            <div class="menu-section"><a href="profesor_notas.html" class="menu-item"><i class="fas fa-edit"></i><span>INGRESAR NOTAS</span></a></div>
            <div class="menu-section"><a href="profesor_estadisticas.html" class="menu-item"><i class="fas fa-edit"></i><span>ESTADISTICAS</span></a></div>
            <div class="menu-section"><a href="profesor_horario.html" class="menu-item"><i class="fas fa-calendar-alt"></i><span>VER HORARIO</span></a></div>
            <div class="menu-section"><a href="profesor_reservaaulalab.html" class="menu-item"><i class="fas fa-door-open"></i><span>DISPONIBILIDAD DE AULAS</span></a></div>
            <div class="menu-section"><a href="nuevo_profesor_contenido.html" class="menu-item active"><i class="fas fa-upload"></i><span>SUBIR SÍLABOS / CONTENIDO</span></a></div>
            <div class="menu-section"><a href="profesor_reportes.html" class="menu-item"><i class="fas fa-file-pdf"></i><span>REPORTES PDF</span></a></div>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Gestión de Sílabos y Contenido</h1>
            <div class="breadcrumb">
                <a href="nuevo_profesor.html" style="color:#7f8c8d;text-decoration:none">Inicio</a>
                <i class="fas fa-chevron-right"></i>
                <span>Sílabos / Contenido</span>
            </div>
        </div>

        <div id="course-blocks-container"></div>
    </div>

    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-icon"><i class="fas fa-check-circle"></i></div>
            <h2 id="modalTitle">¡Operación Exitosa!</h2>
            <p id="modalMsg">El sílabo/contenido ha sido cargado/guardado correctamente al sistema.</p>
            <div class="modal-actions">
                <button class="btn btn-primary" id="goToAttendance"><i class="fas fa-clipboard-check"></i> Ir a Registrar Asistencia</button>
            </div>
        </div>
    </div>

    <script>
    /***** Helpers & Templates (deben estar antes del uso) *****/
    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function createThemeHtml(themeName = '') {
        return `
            <div class="theme-item">
                <input type="text" placeholder="Escribe el tema..." value="${escapeHtml(themeName)}" required>
                <button type="button" class="btn-remove" onclick="this.closest('.theme-item').remove()"><i class="fas fa-trash-alt"></i></button>
            </div>
        `;
    }

    function createUnitHtml(courseCode, unitNumber, unitName = `Unidad ${unitNumber}`, themes = []) {
        const themesHtml = themes.map(t => createThemeHtml(t.nombreTema || t.nombre_tema || '')).join('');
        return `
            <div class="unit-item" data-unit-id="${unitNumber}">
                <div class="unit-header" onclick="toggleThemes(this.closest('.unit-item'))">
                    <h4>
                        <i class="fas fa-chevron-down toggle-themes"></i>
                        <input type="text" value="${escapeHtml(unitName)}" placeholder="Nombre de la Unidad..." style="border:none; background:none; font-weight:bold; color:var(--primary);">
                    </h4>
                    <div class="unit-actions">
                        <button type="button" onclick="event.stopPropagation(); removeUnit('${escapeHtml(courseCode)}', ${unitNumber})"><i class="fas fa-trash"></i> Eliminar</button>
                    </div>
                </div>
                <div class="unit-content">
                    <div class="theme-list">
                        ${themesHtml}
                    </div>
                    <button type="button" class="btn-add-theme" data-add-theme-to="${escapeHtml(courseCode)}" data-unit-id="${unitNumber}"><i class="fas fa-plus"></i> Añadir Tema</button>
                </div>
            </div>
        `;
    }

    const generateCourseBlock = (course) => {
        const hasSyllabus = !!course.hasSyllabus;
        const hasContent = !!course.hasContent;
        const statusClass = hasSyllabus && hasContent ? 'status-uploaded' : 'status-pending';
        const statusText = hasSyllabus && hasContent ? 'Asistencia Desbloqueada' : 'Asistencia Bloqueada';
        const statusIcon = hasSyllabus && hasContent ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
        const uploadBtnText = hasSyllabus ? 'Reemplazar Sílabo (PDF)' : 'Subir Sílabo (PDF)';
        const uploadDisplayContent = hasSyllabus
            ? `<i class="fas fa-file-pdf" style="color: var(--success);"></i> <strong>${escapeHtml(course.code)}_Silabo.pdf</strong> - Subido.`
            : `<i class="fas fa-times-circle" style="color: var(--danger);"></i> Archivo no seleccionado.`;
        const requirementBg = hasSyllabus && hasContent ? '#e6fff1' : '#fff9e6';
        const requirementColor = hasSyllabus && hasContent ? 'var(--success)' : 'var(--warning)';
        const requirementIcon = hasSyllabus && hasContent ? 'fas fa-check-circle' : 'fas fa-info-circle';
        const requirementTitle = hasSyllabus && hasContent ? 'Asistencia Desbloqueada' : 'Requisitos para desbloquear la asistencia';
        const requirementList = hasSyllabus && hasContent
            ? `<li>El sílabo fue cargado y el temario está completo.</li><li>Puede modificar el contenido si es necesario.</li>`
            : `<li>Debe subir el sílabo oficial del curso <strong>(PDF)</strong>.</li><li>Debe ingresar todo el temario <strong>(Unidades y Temas)</strong>.</li><li>La asistencia se habilita cuando el sílabo es subido y el contenido es ingresado.</li>`;

        return `
            <div class="course-upload-block" data-course-code="${escapeHtml(course.code)}">
                <div class="upload-header">
                    <h2 class="upload-title"><i class="fas fa-book upload-icon"></i> ${escapeHtml(course.code)} - ${escapeHtml(course.name)}</h2>
                    <div class="status-badge ${statusClass}"><i class="${statusIcon}"></i> ${statusText}</div>
                </div>

                <div class="requirements" style="background: ${requirementBg}; border-left-color: ${requirementColor};">
                    <h4><i class="${requirementIcon}" style="color: ${requirementColor};"></i> ${requirementTitle}</h4>
                    <ul>${requirementList}</ul>
                </div>

                <div class="syllabus-upload-section">
                    <input type="file" class="input-hidden-file" id="file-${escapeHtml(course.code)}" accept=".pdf" data-course="${escapeHtml(course.code)}">
                    <button type="button" class="btn-upload-syllabus" data-target="file-${escapeHtml(course.code)}"><i class="fas fa-file-upload"></i> ${uploadBtnText}</button>
                    <div class="file-upload-display" id="file-display-${escapeHtml(course.code)}">${uploadDisplayContent}</div>
                </div>

                <div class="content-form">
                    <h3><i class="fas fa-list-ul"></i> Ingreso de Unidades y Temas</h3>
                    <div class="unit-list" id="units-${escapeHtml(course.code)}"></div>

                    <button type="button" class="btn-add-unit" data-course-add-unit="${escapeHtml(course.code)}"><i class="fas fa-plus-circle"></i> Añadir Unidad</button>

                    <button type="button" class="btn btn-save-content" disabled data-course-save="${escapeHtml(course.code)}"><i class="fas fa-save"></i> Guardar Contenido</button>
                </div>
            </div>
        `;
    };

    /***** Estado y helpers para usuario *****/
    function getCurrentUser() {
        try {
            const raw = localStorage.getItem('usuarioDatos');
            if (!raw) return null;
            return JSON.parse(raw);
        } catch (e) {
            console.error('Error parseando localStorage user', e);
            return null;
        }
    }

    let COURSE_DATA = [];

    /***** Core: carga, render y lógica dinámica *****/
    async function loadCoursesFromServer() {
        try {
            const user = getCurrentUser();
            const correoQuery = user && user.correo ? `?correo=${encodeURIComponent(user.correo)}` : '';
            const resp = await fetch('/api/docente/cursos' + correoQuery);
            if (!resp.ok) {
                console.warn('fetch /api/docente/cursos status', resp.status);
                throw new Error('Error al obtener cursos');
            }
            const cursos = await resp.json();
            const map = new Map();
            (cursos || []).forEach(c => {
                const codigo = c.codigoCurso || c.codigo_curso || c.codigo;
                if (!codigo) return;
                if (!map.has(codigo)) {
                    map.set(codigo, { code: codigo, name: c.nombreCurso || c.nombre_curso || 'Sin Nombre', groups: [] });
                }
                map.get(codigo).groups.push({
                    grupoId: c.grupoId || c.grupo_id,
                    letra: c.letraGrupo || c.letra_grupo,
                    tipoClase: c.tipoClase || c.tipo_clase
                });


            });
            COURSE_DATA = Array.from(map.values());
            
            //visualizar COURSE_DATA en consola
            console.log('CARGADOS CURSOS:', COURSE_DATA);

            // Consultar silabos por curso (si tu backend lo soporta)
            await Promise.all(COURSE_DATA.map(async course => {
                try {
                    const r = await fetch(`/api/cursos/${encodeURIComponent(course.code)}/silabos`);
                    console.log('fetch silabo for', course.code, 'status', r.status);
                    if (!r.ok) { course.hasSyllabus = false; return; }
                    const j = await r.json();
                    if (Array.isArray(j) && j.length > 0) {
                        course.hasSyllabus = true;
                        course.silabos = j;
                    } else if (j && j.advertencia) {
                        course.hasSyllabus = false;
                    } else {
                        course.hasSyllabus = Array.isArray(j) && j.length > 0;
                    }
                } catch (err) {
                    console.error('Error consultando silabo para', course.code, err);
                    course.hasSyllabus = false;
                }
                course.hasContent = false;
                course.units = [];

                // dentro del map para cada course (después de consultar silabos)
                try {
                    const contentResp = await fetch(`/api/cursos/${encodeURIComponent(course.code)}/contenido?idUsuario=${user && user.idUsuario ? user.idUsuario : ''}`);
                    if (contentResp.ok) {
                        const contentJson = await contentResp.json();
                        course.silabos = contentJson.silabo; // puede ser null
                        course.units = contentJson.unidades || [];
                        // marca hasContent si existe contenido
                        course.hasContent = (course.units && course.units.length > 0);
                    } else {
                        course.units = [];
                    }
                } catch (e) {
                    console.error('Error cargando contenido para', course.code, e);
                    course.units = [];
                }

            }));
        } catch (err) {
            console.error(err);
            alert('No se pudieron cargar los cursos. Revisa el servidor.');
            COURSE_DATA = []; // fallback
        }
    }

    function renderAllCourses() {
        const container = document.getElementById('course-blocks-container');
        container.innerHTML = '';
        if (!COURSE_DATA || COURSE_DATA.length === 0) {
            container.innerHTML = '<div class="course-upload-block"><p>No se encontraron cursos asignados.</p></div>';
            return;
        }
        COURSE_DATA.forEach(course => container.insertAdjacentHTML('beforeend', generateCourseBlock(course)));
        COURSE_DATA.forEach(course => renderUnitsForCourse(course));
    }

    function renderUnitsForCourse(course) {
    const unitList = document.getElementById(`units-${course.code}`);
    if (!unitList) return;
    unitList.innerHTML = '';
    if (Array.isArray(course.units) && course.units.length > 0) {
        course.units.forEach(u => {
            const numero = u.numeroUnidad || u.numero_unidad || 1;
            const temas = u.temas || [];
            unitList.insertAdjacentHTML('beforeend', createUnitHtml(course.code, numero, u.nombreUnidad || u.nombre_unidad || `Unidad ${numero}`, temas));
        });
    }
    updateSaveButtonState(course.code);
}


    // Delegated event handling + init logic
    function initDynamicContentLogic() {
        // Delegated clicks (añadir unidad, añadir tema, guardar, upload button)
        document.addEventListener('click', (e) => {
            const addUnitBtn = e.target.closest('.btn-add-unit');
            if (addUnitBtn) {
                const courseCode = addUnitBtn.getAttribute('data-course-add-unit');
                addUnit(courseCode);
                return;
            }

            const addThemeBtn = e.target.closest('.btn-add-theme');
            if (addThemeBtn) {
                e.stopPropagation();
                const courseCode = addThemeBtn.getAttribute('data-add-theme-to');
                const unitId = addThemeBtn.getAttribute('data-unit-id');
                addTheme(courseCode, unitId);
                return;
            }

            const saveBtn = e.target.closest('.btn-save-content');
            if (saveBtn) {
                const courseCode = saveBtn.getAttribute('data-course-save');
                saveContent(courseCode);
                return;
            }

            const uploadBtn = e.target.closest('.btn-upload-syllabus');
            if (uploadBtn) {
                const targetId = uploadBtn.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if (input) input.click();
                return;
            }
        });

        // Delegated change for file inputs
        document.addEventListener('change', (e) => {
            const input = e.target;
            if (!input || !input.classList.contains('input-hidden-file')) return;
            const file = input.files[0];
            const courseCode = input.getAttribute('data-course');
            const displayEl = document.getElementById(`file-display-${courseCode}`);
            if (file) {
                if (file.size > 10 * 1024 * 1024) {
                    alert('Archivo demasiado grande (máx 10MB).');
                    input.value = '';
                    if (displayEl) displayEl.innerHTML = `<i class="fas fa-times-circle" style="color: var(--danger);"></i> Archivo demasiado grande.`;
                    return;
                }
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                    alert('Solo se permiten archivos PDF.');
                    input.value = '';
                    if (displayEl) displayEl.innerHTML = `<i class="fas fa-times-circle" style="color: var(--danger);"></i> Tipo no permitido.`;
                    return;
                }
                if (displayEl) displayEl.innerHTML = `<i class="fas fa-file-pdf" style="color: var(--primary);"></i> <strong>${escapeHtml(file.name)}</strong> - Enviando...`;
                uploadSyllabus(courseCode, file).then(() => {
                    if (displayEl) displayEl.innerHTML = `<i class="fas fa-file-pdf" style="color: var(--success);"></i> <strong>${escapeHtml(file.name)}</strong> - Subido.`;
                }).catch(err => {
                    console.error(err);
                    alert('Error subiendo archivo: ' + (err.message || err));
                    if (displayEl) displayEl.innerHTML = `<i class="fas fa-times-circle" style="color: var(--danger);"></i> Error en la subida.`;
                });
            } else {
                if (displayEl) displayEl.innerHTML = `<i class="fas fa-times-circle" style="color: var(--danger);"></i> Archivo no seleccionado.`;
            }
        });

        // Inputs: habilitar guardar si hay unidades
        document.addEventListener('input', (e) => {
            if (e.target.tagName !== 'INPUT') return;
            const courseBlock = e.target.closest('.course-upload-block');
            if (!courseBlock) return;
            const courseCode = courseBlock.getAttribute('data-course-code');
            updateSaveButtonState(courseCode);
        });
    }

    // UI helpers: toggle, add/remove units/themes, update save button
    window.toggleThemes = (unitElement) => {
        if (!unitElement) return;
        unitElement.classList.toggle('collapsed');
    };

    function addUnit(courseCode) {
        const unitList = document.getElementById(`units-${courseCode}`);
        if (!unitList) return;
        let maxUnit = 0;
        unitList.querySelectorAll('.unit-item').forEach(unitEl => {
            const id = parseInt(unitEl.getAttribute('data-unit-id'), 10) || 0;
            if (id > maxUnit) maxUnit = id;
        });
        const newUnitNumber = maxUnit + 1;
        const unitHtml = createUnitHtml(courseCode, newUnitNumber);
        unitList.insertAdjacentHTML('beforeend', unitHtml);
        updateSaveButtonState(courseCode);
    }

    window.removeUnit = (courseCode, unitId) => {
        const unitElement = document.querySelector(`#units-${courseCode} .unit-item[data-unit-id="${unitId}"]`);
        if (unitElement && confirm('¿Está seguro de eliminar esta Unidad y todos sus temas?')) {
            unitElement.remove();
            updateSaveButtonState(courseCode);
        }
    };

    function addTheme(courseCode, unitId) {
        const unitElement = document.querySelector(`#units-${courseCode} .unit-item[data-unit-id="${unitId}"]`);
        if (!unitElement) return;
        const themeList = unitElement.querySelector('.theme-list');
        themeList.insertAdjacentHTML('beforeend', createThemeHtml());
        const newThemeInput = themeList.lastElementChild.querySelector('input');
        if (newThemeInput) newThemeInput.focus();
        unitElement.classList.remove('collapsed');
        updateSaveButtonState(courseCode);
    }

    function updateSaveButtonState(courseCode) {
        const unitList = document.getElementById(`units-${courseCode}`);
        const saveBtn = document.querySelector(`.btn-save-content[data-course-save="${courseCode}"]`);
        if (!saveBtn) return;
        const hasUnits = unitList && unitList.children.length > 0;
        saveBtn.disabled = !hasUnits;
    }

    // Backend calls: subir sílabo y guardar contenido
    async function uploadSyllabus(courseCode, file) {
        try {
            const fd = new FormData();
            fd.append('file', file);
            const user = getCurrentUser();
            if (user && user.idUsuario) fd.append('idDocente', user.idUsuario);

            const resp = await fetch(`/api/cursos/${encodeURIComponent(courseCode)}/silabo`, { method: 'POST', body: fd });
            if (!resp.ok) {
                const txt = await resp.text();
                throw new Error(txt || ('HTTP ' + resp.status));
            }
            const j = await resp.json();
            const course = COURSE_DATA.find(c => c.code === courseCode);
            if (course) course.hasSyllabus = true;
            updateCourseBlockStatus(courseCode);
            return j;
        } catch (err) {
            throw err;
        }
    }

async function saveContent(courseCode) {
    const unitsEl = document.getElementById(`units-${courseCode}`);
    if (!unitsEl) return;

    // Construir payloadUnits a partir del DOM
    const payloadUnits = [];
    unitsEl.querySelectorAll('.unit-item').forEach((unitEl, unitIdx) => {
        // Si el unit-item tiene data-unit-id la usamos como número; si no, usamos el índice+1
        const unitIdAttr = unitEl.getAttribute('data-unit-id');
        const numero = unitIdAttr ? parseInt(unitIdAttr, 10) : (unitIdx + 1);

        const unitNameInput = unitEl.querySelector('input[type="text"]');
        const unitName = unitNameInput ? unitNameInput.value.trim() : `Unidad ${numero}`;

        const themesArr = [];
        unitEl.querySelectorAll('.theme-list .theme-item').forEach((themeEl, themeIdx) => {
            const themeInput = themeEl.querySelector('input[type="text"]');
            const themeName = themeInput ? themeInput.value.trim() : '';
            if (themeName) {
                themesArr.push({
                    numero: themeIdx + 1,
                    name: themeName
                });
            }
        });

        // Solo incluimos unidades con al menos 1 tema (misma lógica que antes)
        if (themesArr.length > 0) {
            payloadUnits.push({
                numero: numero,
                name: unitName,
                themes: themesArr
            });
        }
    });

    if (payloadUnits.length === 0) {
        alert('Debe añadir al menos una unidad con temas antes de guardar.');
        return;
    }

    // Obtener datos del curso desde COURSE_DATA para enviar idCiclo/grupo/ruta si están disponibles
    const course = COURSE_DATA.find(c => c.code === courseCode);
    const user = getCurrentUser();

    const payload = {
        units: payloadUnits,
        // idDocente en tu backend se interpreta como idUsuario (según conversación).
        // Ajusta si tu backend espera el id_docente real.
        idDocente: user && user.idUsuario ? user.idUsuario : null,
        idCiclo: course && course.silabos ? (course.silabos.idCiclo || course.silabos.id_ciclo || null) : null,
        grupoTeoria: course && course.silabos ? (course.silabos.grupoTeoria || course.silabos.grupo_teoria || null) : null,
        rutaArchivo: course && course.silabos ? (course.silabos.rutaArchivo || course.silabos.ruta_archivo || null) : null
    };

    const saveBtn = document.querySelector(`.btn-save-content[data-course-save="${CSS.escape(courseCode)}"]`);
    try {
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        }

        const resp = await fetch(`/api/cursos/${encodeURIComponent(courseCode)}/contenido`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!resp.ok) {
            // intentar leer texto/JSON para detalle del error
            let errText;
            try { errText = await resp.text(); } catch (e) { errText = 'Error'; }
            throw new Error(errText || `HTTP ${resp.status}`);
        }

        const j = await resp.json();

        // Actualizar estado local COURSE_DATA con lo que guardamos
        if (course) {
            // convertimos payloadUnits a la forma usada localmente
            course.units = payloadUnits.map(u => ({
                numeroUnidad: u.numero,
                nombreUnidad: u.name,
                temas: u.themes.map(t => ({ nombreTema: t.name }))
            }));
            course.hasContent = true;
        }

        updateCourseBlockStatus(courseCode);
        // Re-renderizar unidades para normalizar IDs/DOM
        if (course) {
            renderUnitsForCourse(course);
        }

        // Mostrar modal de éxito
        document.getElementById('modalTitle').textContent = '¡Contenido Guardado Exitosamente!';
        if (course && course.hasSyllabus) {
            document.getElementById('modalMsg').textContent = `El contenido del curso ${courseCode} ha sido guardado. ¡Asistencia Desbloqueada!`;
        } else {
            document.getElementById('modalMsg').textContent = `El contenido del curso ${courseCode} ha sido guardado. Recuerda subir el Sílabo (PDF) para desbloquear la asistencia.`;
        }
        document.getElementById('successModal').classList.add('active');

        return j;
    } catch (err) {
        console.error('Error guardando contenido:', err);
        // Mostrar mensaje útil al usuario
        alert('Error guardando contenido: ' + (err.message || err));
    } finally {
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Contenido';
        }
    }
}


    function updateCourseBlockStatus(courseCode) {
        const course = COURSE_DATA.find(c => c.code === courseCode);
        const block = document.querySelector(`.course-upload-block[data-course-code="${CSS.escape(courseCode)}"]`);
        if (!block || !course) return;
        const statusBadge = block.querySelector('.status-badge');
        const requirements = block.querySelector('.requirements');
        if (course.hasSyllabus && course.hasContent) {
            statusBadge.className = 'status-badge status-uploaded';
            statusBadge.innerHTML = `<i class="fas fa-check-circle"></i> Asistencia Desbloqueada`;
            requirements.style.background = '#e6fff1';
            requirements.style.borderLeftColor = 'var(--success)';
            const h4 = requirements.querySelector('h4'); if (h4) h4.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success);"></i> Asistencia Desbloqueada`;
            const ul = requirements.querySelector('ul'); if (ul) ul.innerHTML = `<li>El sílabo fue cargado y el temario está completo.</li><li>Puede modificar el contenido si es necesario.</li>`;
        } else {
            statusBadge.className = 'status-badge status-pending';
            statusBadge.innerHTML = `<i class="fas fa-exclamation-circle"></i> Asistencia Bloqueada`;
            requirements.style.background = '#fff9e6';
            requirements.style.borderLeftColor = 'var(--warning)';
            const h4 = requirements.querySelector('h4'); if (h4) h4.innerHTML = `<i class="fas fa-info-circle" style="color: var(--warning);"></i> Requisitos para desbloquear la asistencia`;
            const ul = requirements.querySelector('ul'); if (ul) ul.innerHTML = `<li>Debe subir el sílabo oficial del curso <strong>(PDF)</strong>.</li><li>Debe ingresar todo el temario <strong>(Unidades y Temas)</strong>.</li><li>La asistencia se habilita cuando el sílabo es subido y el contenido es ingresado.</li>`;
        }
    }

    /***** Inicialización DOMContentLoaded *****/
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCoursesFromServer();
        renderAllCourses();
        initDynamicContentLogic();
        // Agregar listener al botón del modal
        const goToAttendanceBtn = document.getElementById('goToAttendance');
        if (goToAttendanceBtn) {
            goToAttendanceBtn.addEventListener('click', () => {
                document.getElementById('successModal').classList.remove('active');
                window.location.href = 'nuevo_profesor_asistenciabloqueada.html';
            });
        }
        // Cerrar modal clicando fuera
        const successModal = document.getElementById('successModal');
        if (successModal) {
            successModal.addEventListener('click', (e) => { if (e.target === e.currentTarget) successModal.classList.remove('active'); });
        }
    });
    </script>
</body>
</html>
